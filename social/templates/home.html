{% load humanize %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KishiFace - Home</title>
  <script src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.7/dist/htmx.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link rel="stylesheet" href="{% static 'css/home.css' %}">
  <style>
   
  </style>
</head>
<body>

<header>
  <h1>KishiFace</h1>
  <div class="icon-group">
    <a href="{% url 'notification_list' %}" style="text-decoration: none; position: relative;">
        <i class="fa-regular fa-bell" style="cursor:pointer;"></i>
        {% if notifications.count > 0 %}
            <sup style="color: red; font-weight: bold; position: absolute; top: 0; right: -5px; font-size: 10px;">{{notifications.count}}</sup>
        {% endif %}
    </a>
    <a href="{% url 'inbox' %}"><i class="fa-regular fa-paper-plane" style="cursor:pointer;"></i></a>
  </div>
</header>

<main class="container">
    
    <!-- ============================================== -->
    <!-- 1. LEFT SIDEBAR (Desktop Only: Profile, Settings, etc.) -->
    <!-- Uses desktop-only class -->
    <!-- ============================================== -->
    <div class="left-sidebar desktop-only">
        <div class="card">
            <div class="sidebar-content">
                <h4 class="sidebar-title">My Account</h4>
                
                <a href="{% url 'profile' request.user.username %}" class="sidebar-link">
                    <i class="fa-solid fa-user-circle"></i> Profile
                </a>
                <a href="" class="sidebar-link">
                    <i class="fa-solid fa-cog"></i> Settings
                </a>
                <a href="{% url 'post' %}" class="sidebar-link">
                <i><svg fill="none" stroke="currentColor" height="20" width="20" viewBox="0 0 24 24">
                  <circle cx="12" cy="12" r="10" stroke-width="2"/>
                  <line x1="12" y1="8" x2="12" y2="16" stroke-width="2"/>
                  <line x1="8" y1="12" x2="16" y2="12" stroke-width="2"/>
                </svg></i> Post
              </a>
                <hr class="sidebar-divider">
                <a href="{% url 'logout' %}" class="sidebar-link logout">
                    <i class="fa-solid fa-right-from-bracket"></i> Logout
                </a>
            </div>
        </div>
    </div>

    <!-- ============================================== -->
    <!-- 2. MAIN FEED (Center Column) -->
    <!-- ============================================== -->
    <div class="main-feed">

        <!-- Face You May Know (MOBILE/TABLET VIEW) -->
        <div class="member-suggest-card mobile-only" id="mobile-member-section">
            <h4>Faces You May Know</h4>
            <div class="member-list-horizontal">
                {% for member in members %}
                    {% if request.user != member %}
                        <div class="member-item">
                            <a href="{% url 'profile' member.username %}" style="text-decoration: none;">
                                <div class="member-pic-wrapper">
                                    <img src="{{member.profile.picture.url}}" 
                                         
                                         alt="{{member.username}}" 
                                         class="member-pic">
                                </div>
                                <span class="member-username">{% if user.profile.full_name %} {{user.profile.full_name}} {% else %}{{member.username}} {% endif %}</span>
                            </a>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
        <!-- End Mobile Member Section -->


        <!-- POST FEED -->
        {% for post in page_obj.object_list %}
        <article class="card">
            <div class="post-header">
                <div class="post-user">
                    <img src="{{post.author.profile.picture.url}}" onerror="this.onerror=null; this.src='https://placehold.co/40x40/cccccc/ffffff?text=P';" alt="{{post.author.username}}" class="profile-pic">
                    <div class="user-details">
                        <a href="{% url 'profile' post.author.username %}" class="username-link">{{post.author.first_name}} {{post.author.last_name}}</a>
                        <div class="post-meta">
                            @{{post.author.username}}Â· {{post.created_at|timesince}} ago
                        </div>
                    </div>
                </div>
                
                <!-- Post Action Icons (Now using pure CSS classes) -->
                <div class="action-buttons">
                    {% if request.user == post.author %}
                    <a href="" 
                       title="Edit Post"
                       class="post-icon-button">
                        <i class="fa-solid fa-pen-to-square"></i>
                    </a>
                    <a href="" 
                       title="Delete Post"
                       class="post-icon-button delete-btn">
                        <i class="fa-solid fa-trash"></i>
                    </a>
                    {% else %}
                    <i class="fa-solid fa-ellipsis post-ellipsis-icon" 
                       style="cursor:pointer;"></i>
                    {% endif %}
                </div>
                <!-- END EDITED SECTION -->

            </div>
            <b class="post-title" style="color: var(--text-dark);">{{post.content}}</b>

            {% if post.images.all %}
            <div class="post-image-carousel" id="carousel-{{ post.post_id }}" data-current-slide="0" data-total-slides="{{ post.images.all|length }}">
                <div class="slider-track" id="track-{{ post.post_id }}">
                    {% for p in post.images.all %}
                    <img src="{{p.image.url}}" onerror="this.onerror=null; this.src='https://placehold.co/600x400/999999/ffffff?text=KishiFace+Post';" alt="Post Image {{forloop.counter}}" class="post-image-slide">
                    {% empty %}
                    <img src="https://placehold.co/600x400/999999/ffffff?text=KishiFace" alt="No Post Image" class="post-image-slide">
                    {% endfor %}
                </div>

                {% if post.images.all|length > 1 %}
                <div class="slide-nav">
                    <button id="prev-{{ post.post_id }}" onclick="slidePost('{{ post.post_id }}', -1)" class="hidden"><i class="fa-solid fa-chevron-left"></i></button>
                    <button id="next-{{ post.post_id }}" onclick="slidePost('{{ post.post_id }}', 1)"><i class="fa-solid fa-chevron-right"></i></button>
                </div>

                <div class="slider-indicators" id="indicators-{{ post.post_id }}">
                    {% for p in post.images.all %}
                    <div class="indicator-dot {% if forloop.first %}active{% endif %}"></div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- Post Like Snippet -->
            {% include 'snippet/post_like.html' %}
        </article>
        {% empty %}
        <div class="card text-center" style="padding:40px; margin-top: 20px;">
            <h3>No Posts Yet</h3>
            <p style="color: var(--text-muted);">Start by sharing your first moment!</p>
        </div>
        {% endfor %}

        <!-- HTMX Load More -->
        {% if page_obj.has_next %}
        <a id="load-more-container"
            href="?page={{page_obj.next_page_number}}"
           >
            see more
          </a>
        {% endif %}
    </div> <!-- End main-feed -->

    <!-- ============================================== -->
    <!-- 3. RIGHT SIDEBAR (Desktop Only: Faces You May Know) -->
    <!-- Uses desktop-only class -->
    <!-- ============================================== -->
    <div class="right-sidebar desktop-only">
        <div class="card">
            <div class="sidebar-content">
                <h4 class="desktop-member-title">Faces You May Know</h4>
                <div class="desktop-member-list">
                    {% for member in members %}
                        {% if request.user != member %}
                            <div class="desktop-member-item">
                                <a href="{% url 'profile' member.username %}">
                                    <div class="member-pic-wrapper" style="background: var(--border-color); padding: 0;">
                                        <img src="{{member.profile.picture.url}}" 
                                             
                                             alt="{{member.username}}" 
                                             class="member-pic">
                                    </div>
                                    <div>
                                        <span class="member-username block">{{member.first_name}} {{member.last_name}}</span>
                                        <span class="member-title block">@{{member.username}}</span>
                                    </div>
                                </a>
                                <!-- Placeholder follow button -->
                                <button class="btn btn-blue btn-follow">Follow</button>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div> <!-- End right-sidebar -->

</main>

<!-- MOBILE-ONLY FOOTER (Uses mobile-only class) -->
<footer class="mobile-only">
    {% include 'footer.html' %}
</footer>

<script>
  /**
   * Handles sliding of a post's image carousel.
   * @param {string} postId - The unique ID of the post.
   * @param {number} direction - -1 for previous, 1 for next.
   */
  function slidePost(postId, direction) {
    const carousel = document.getElementById(`carousel-${postId}`);
    const track = document.getElementById(`track-${postId}`);
    const indicatorsContainer = document.getElementById(`indicators-${postId}`);
    const prevButton = document.getElementById(`prev-${postId}`);
    const nextButton = document.getElementById(`next-${postId}`);

    if (!carousel || !track) return;

    let currentSlide = parseInt(carousel.getAttribute('data-current-slide') || '0');
    const totalSlides = parseInt(carousel.getAttribute('data-total-slides') || '1');

    if (totalSlides <= 1) return;

    let newSlide = currentSlide;

    if (direction !== 0) { // Only update slide index if direction is provided
        newSlide = currentSlide + direction;
    }

    // Clamp the new slide index
    if (newSlide < 0) {
      newSlide = 0;
    } else if (newSlide >= totalSlides) {
      newSlide = totalSlides - 1;
    }

    // 1. Update the slider position using CSS transform
    const slideWidth = carousel.clientWidth;
    const offset = newSlide * slideWidth;
    track.style.transform = `translateX(-${offset}px)`;

    // 2. Update the state attribute
    carousel.setAttribute('data-current-slide', newSlide);

    // 3. Update indicators
    if (indicatorsContainer) {
      indicatorsContainer.querySelectorAll('.indicator-dot').forEach((dot, index) => {
        dot.classList.toggle('active', index === newSlide);
      });
    }

    // 4. Update navigation buttons visibility
    if (prevButton) {
      prevButton.classList.toggle('hidden', newSlide === 0);
    }
    if (nextButton) {
      nextButton.classList.toggle('hidden', newSlide === totalSlides - 1);
    }
  }

  /**
   * Initializes all carousels on the page.
   */
  function initCarousels() {
    // Select all carousels that have more than one slide (checked by total-slides attribute)
    document.querySelectorAll('.post-image-carousel[data-total-slides]:not([data-total-slides="1"])').forEach(carousel => {
        const postId = carousel.id.split('-')[1];
        // Call slidePost with 0 direction to initialize current position and button visibility
        slidePost(postId, 0);
    });
  }

  // Ensure carousels are initialized and responsive on load and resize
  window.addEventListener('resize', initCarousels);
  window.addEventListener('load', initCarousels);

  // Fallback for immediate execution if the document is already ready
  if (document.readyState === 'complete' || document.readyState === 'interactive') {
      initCarousels();
  }
</script>
</body>
</html>

